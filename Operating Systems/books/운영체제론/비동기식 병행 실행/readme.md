# 5 비동기식 병행 실행

## 5.1 소개

한시스템에 동시에 여러개의 스레드가 존재하는 것을 가리켜 스레드들이 병행한다고한다. 두 병행 스레드는 서로완전히 독립적으로 실행할 수 있고, 서로 협력하며 실행할 수도 있다. 서로 독립적으로 실행하지만 때로는 서로의사소통하고 동기화해 협력하는 가운데 특정 업무를 실행해야하는 스레드들을 비동기적으로 실행한다고 표현한다. 비동기성은 복잡한주제이다. 

## 5.2 상호 배제

배타적인 접근 exclusive access . 한 스레드가 공유 변수의 값을 증가시키는 동안에는 다른 모든 스레드에서 이변수를접근하지 않고 우선대기한다. 그리고 실행중인 스레드가 공유변수를 스레드가 공유 변수를 사용하는 작업을 마치고 나서야 시스템이 대기중인 프로세스중 하나가 공유 변수를 접근할 수 있게 해야한다. 이를 공유 변수에 대한 접근을 순차화 한다고 한다. 이러한 방식으로 스레드들이 공유 변수에 동시에 접근하는 일을 막을 수 있다. 즉 한 스레드가 공유 변수를 갱신하는 동안에 다른스세드들이 동시에 접근하는 일을 막는다. 이를 상호배제라고한다. 

### 5.2.1 자바 멀티스레딩 사례연구 2: 생산자/소비자 관계

생산자/소비자 관계에서 생산자는 데이터를 생산해 공유 객체에 저장하고 소비자는 공유 객체에서 데이터를 읽는다. 프린터의 스풀링 기능에서 생산자 / 소비자 관계의 한예를 볼수 있다. 생산자 스레드는 데이터를 생성해 값을 하나만 넣을 수 있는 버퍼에 놓는다. 소비자 스레드는 버퍼에서 데이터를 읽어간다. 생산자가 다음 데이터를 버퍼에 놓으려고 할 때 소비자가 아직 이전에 넣은 데이터를 읽어가지 않은 사실을 발견하면 대기 한다. 먼저 소비자가 데이터를 읽어가야 이전에 쓴 데이터를 덮어쓰지 않기 때문이다. 소비자가 데이터를 읽을 때는 대기중인 생산자가 다음 값을 버퍼에 저장하도록 통지해야한다. Object 클래스의 notify 메소드는 스레드가 대기상태에서준비상태로 변하게 해준다. 병행 스레드들이 공유 데이터를 조작하는 것을 동기화하지 않으면 어떤 오류가 발생하는지 알아보자.

동시에 실행되는 스레드들은 공유 데이터에 접근할 때 주의를 기울여 조절해야한다. 그렇지 않다면 프로그램은 잘못된 결과를 낸다. 


### 5.2.2 임계 영역

상호 배제는 여러 스레드에서 공유하고 수정 가능한 데이터에 접근할 때만 사용해야한다. 값을 단순히 조회하는 등 스레드들이 서로 충돌하지 않는 기능을 수행하면 시스템은 스레드들이 동시에 진행하는 것을 허용해야한다. 스레드가 수정 가능한 공유 데이터에 접근할 때 스레드가 임계 영역에 있다고 한다. critical section 시스템은 앞에서 다룬 오류들을 방지하기 위해 한번에 한 스레드만 임계 영역의 특정 자원에 접근해 실행하도록 보장해야한다. 스레드가 임계 영역에 들어가려고 할 때 다른 스레드가 이미 임계 영역 안에 있다면, 다음 스레드는 실행중인 스레드가 임계 영역에 들어가려고 할 때 다른 스레드가 이미 임계 영역안에있다면, 다음 실행중인 스레드가 임계 영역을 나올때 까지 대기하낟. 스레드가 임계 영역을 빠져나오면 대기하던 스레드가 임계 영역에 들어가 실행할 수 있다. 임계 영역에 들어갈 필요가 없는 스레드는 임계 영역에 다른 스레드가 있든 없든 진행을 계속할 수 있다.

상호 배제를 시행하는 시스템은 임계 영역에 대한 접근과 그 안에서 일어나는 실행을 주의깊게 제어해야한다. 임계 영역에 있는 스레드는 수정 가능한 공유 데이터에대한 배타적인 접근 권한을 가지며, 현재 접근을 시도하는 다르 ㄴ모든 스레드는 대기한다. 

그러므로 스레드는 임계 영역에서는 가능하면 빨리 실행해야한다. 스레드가 임계 영역안에서 블록되면 안된다. 임계 영역에 있는 스레드가 종료되면 운영체제는 종료 정리 작업을 수행할 때 상호배제를 해제해 다른 스레드들이 임계영역에 들어올 수 있게 해야한다.



### 5.2.3 상호 배제 프리미티브

동일한 프로세스의스레드 t1 과 t2 를 실행중이라하자. 각 스레드는 이메일 메시지를 관리하고, t1 이 enterMutaulExclusion() 부분에 도달했을 때 시스템은 t2 가 벌써 자신의 임계 영역에 도달했는지 확인해야한다 . t2 가 임계 영역에 있지 않으면 t1 은 자신의 임계 영역에 들어가 공유변수를 증가시키고 exitMutaulExclusion()을 수행해 t1이 임계 영역을 빠져나옴을 알려준다. t1 이 enterMutaulExclusion()을 수행할 때 t2 가 자신의 임계 영역에 있다면, t1 은 t2 의 exitMutualExclusion()수행을 기다린다. t1 과 t2 가 동시에 enterMutualExclusion()을 수행하면 두스레드중 하나만 진입이 허용되고 다른하나는 계속대기한다. 


## 5.3 상호배제 프리미티브 구현


여기서 논의하는 초기 상호배제 해결책은 enterMutualExclusion() 과 exitMutualExclusion()
구현에서 다음과 같은 속성을 지닌다.

1. 특별히 상호배제를 위해 설계된 기계어 명령어 없이, 순수하게 소프트웨어로 구현된 해결책이다. 각 기계어 명령어는 분할 할 수 없게 실행된다. 시스템에 프로세서가 여러개 있으면 동시에 여러 스레드가 동일한 데이터에 접근을 시도할 수 있다. 앞으로 살펴보겠지만 단일 프로세서 시스템의 상호 배제 해결책은 공유 데이터에 대한 접근에 의존하는 경우가많다. 이런 해결책은 멀티프로세서 시스템에서는 전혀 해결책이 되지 못할 수도 있다. 
2. 비동기 병행 스레드들 간의 상대적인 속도에 대해서는 아무런 가정도 하지 않는다.  이는 어느 해결책이든 실행중인 스레드가 선점당하거나 재시작할 수 있음을 고려해야한다는 의미이다. 또한 각 스레드의 실행 비율이 일정하지 않고 예측할 수 없을 수도 있다는 의미이다. 
3. 임계 영역 밖에서 명령어를 실행하는 스레드는 다른 스레드들이 자신들의 임계 영역에 들어가는 것을 막을 수 없다.
4. 스레드가 임계 영역에 들어가는 일이 무기한 연기하면 안된다.

## 5.4 상호 배제 문제에 대한 소프트웨어 해결책

239쪽부터 읽어 나 책반납할꺼임
